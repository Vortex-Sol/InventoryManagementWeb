<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout-noSearch ::
        layout(title=~{::title}, content=~{::section}, navText='Warehouses')}">
<head>
    <title th:text="${mode == 'edit' ? 'Edit Warehouse' : (mode == 'create' ? 'Create Warehouse' : 'Warehouses')}">
        Warehouses
    </title>
</head>

<section>

    <div th:if="${deleteError}" class="alert alert-danger" th:text="${deleteError}"></div>

    <div th:if="${mode == 'list'}" class="row">
        <div class="col-12 d-flex justify-content-end mb-3">
            <a class="btn btn-primary" th:href="@{/api/super/warehouses/create}">Create Warehouse</a>
        </div>

        <div class="col-12">
            <div class="card">
                <div class="card-header"><h4 class="mb-0">All Warehouses</h4></div>
                <div class="card-body table-responsive">
                    <table class="table align-middle">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Address</th>
                            <th class="text-end">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="w : ${warehouses}">
                            <td th:text="${w.id}"></td>
                            <td th:text="${w.phone}"></td>
                            <td th:text="${w.email}"></td>
                            <td th:text="${w.address}"></td>
                            <td class="text-end">
                                <div class="d-inline-flex gap-2">
                                    <a class="btn btn-sm btn-outline-primary"
                                       th:href="@{/api/super/warehouses/{id}/edit(id=${w.id})}">Edit</a>

                                    <form th:action="@{/api/super/warehouses/{id}/delete(id=${w.id})}"
                                          method="post"
                                          th:onsubmit="|return confirm('Delete warehouse #' + [[${w.id}]] + '?');|">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                        <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(warehouses)}">
                            <td colspan="5" class="text-center text-muted">No warehouses yet.</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="card-footer">
                    <a th:href="@{/api/super}">Back to Super Admin</a>
                </div>
            </div>
        </div>
    </div>

    <div th:if="${mode == 'create' or mode == 'edit'}" class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h4 th:text="${mode == 'edit' ? 'Edit Warehouse' : 'Create New Warehouse'}">Create New Warehouse</h4>
                    <p class="text-muted mb-0">Create or edit a warehouse and link it to an existing (or brand new) Tax Rate.</p>
                </div>

                <div class="card-body">
                    <form th:if="${mode == 'edit'}"
                          th:object="${warehouseForm}"
                          th:action="@{/api/super/warehouses/{id}/update(id=${warehouseForm.id})}"
                          method="post" id="warehouseFormEdit">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <input type="hidden" th:field="*{id}"/>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Phone</label>
                                <input class="form-control" th:field="*{phone}" maxlength="20" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input class="form-control" th:field="*{email}" type="email" maxlength="50" required>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Address</label>
                                <input class="form-control" th:field="*{address}" maxlength="250" required>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="mb-3">
                            <label class="form-label">Tax Rate Option</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="taxRateMode" id="modeExistingEdit" value="existing" th:checked="${true}">
                                <label class="form-check-label" for="modeExistingEdit">Use existing Tax Rate</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="taxRateMode" id="modeNewEdit" value="new">
                                <label class="form-check-label" for="modeNewEdit">Create new Tax Rate</label>
                            </div>
                        </div>

                        <div id="existingRateBlockEdit" class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Tax Rate</label>
                                <select class="form-select" name="existingTaxRateId" id="existingTaxRateIdEdit" required>
                                    <option value="" disabled th:if="${currentTaxRate == null}" selected>Choose...</option>
                                    <option th:each="r : ${taxRates}" th:value="${r.id}"
                                            th:text="${r.country + ' — Std: ' + r.standardRate}"
                                            th:selected="${currentTaxRate != null and currentTaxRate.id == r.id}"></option>
                                </select>
                                <div class="form-text">Manage rates in <a th:href="@{/api/super/taxes}">Tax Rates</a>.</div>
                            </div>
                        </div>

                        <div id="newRateBlockEdit" class="row g-3 d-none border rounded p-3 mt-2">
                            <div class="col-12"><strong>New Tax Rate</strong></div>
                            <div class="col-md-4">
                                <label class="form-label">Country</label>
                                <select class="form-select" name="newRateCountry" id="newRateCountryEdit">
                                    <option value="" disabled selected>Choose...</option>
                                    <option th:each="c : ${countries}" th:value="${c}" th:text="${c}"></option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Standard</label>
                                <input class="form-control" name="newRateStandardRate" type="number" step="0.001" min="0">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Reduced</label>
                                <input class="form-control" name="newRateReducedRate" type="number" step="0.001" min="0">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Super Reduced</label>
                                <input class="form-control" name="newRateSuperReducedRate" type="number" step="0.001" min="0">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">None</label>
                                <input class="form-control" name="newRateNoneRate" type="number" step="0.001" min="0">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Other</label>
                                <input class="form-control" name="newRateOtherRate" type="number" step="0.001" min="0">
                            </div>
                        </div>

                        <div class="mt-4 d-flex gap-2">
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                            <a class="btn btn-outline-secondary" th:href="@{/api/super/warehouses}">Cancel</a>
                        </div>
                    </form>

                    <form th:if="${mode == 'create'}"
                          th:object="${warehouseForm}"
                          th:action="@{/api/super/warehouses/create}"
                          method="post" id="warehouseFormCreate">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Phone</label>
                                <input class="form-control" th:field="*{phone}" maxlength="20" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input class="form-control" th:field="*{email}" type="email" maxlength="50" required>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Address</label>
                                <input class="form-control" th:field="*{address}" maxlength="250" required>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="mb-3">
                            <label class="form-label">Tax Rate Option</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="taxRateMode" id="modeExistingCreate" value="existing" checked>
                                <label class="form-check-label" for="modeExistingCreate">Use existing Tax Rate</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="taxRateMode" id="modeNewCreate" value="new">
                                <label class="form-check-label" for="modeNewCreate">Create new Tax Rate</label>
                            </div>
                        </div>

                        <div id="existingRateBlockCreate" class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Tax Rate</label>
                                <select class="form-select" name="existingTaxRateId" id="existingTaxRateIdCreate" required>
                                    <option value="" disabled selected>Choose...</option>
                                    <option th:each="r : ${taxRates}" th:value="${r.id}"
                                            th:text="${r.country + ' — Std: ' + r.standardRate}"></option>
                                </select>
                                <div class="form-text">Manage rates in <a th:href="@{/api/super/taxes}">Tax Rates</a>.</div>
                            </div>
                        </div>

                        <div id="newRateBlockCreate" class="row g-3 d-none border rounded p-3 mt-2">
                            <div class="col-12"><strong>New Tax Rate</strong></div>
                            <div class="col-md-4">
                                <label class="form-label">Country</label>
                                <select class="form-select" name="newRateCountry" id="newRateCountryCreate">
                                    <option value="" disabled selected>Choose...</option>
                                    <option th:each="c : ${countries}" th:value="${c}" th:text="${c}"></option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Standard</label>
                                <input class="form-control" name="newRateStandardRate" type="number" step="0.001" min="0">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Reduced</label>
                                <input class="form-control" name="newRateReducedRate" type="number" step="0.001" min="0">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Super Reduced</label>
                                <input class="form-control" name="newRateSuperReducedRate" type="number" step="0.001" min="0">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">None</label>
                                <input class="form-control" name="newRateNoneRate" type="number" step="0.001" min="0">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Other</label>
                                <input class="form-control" name="newRateOtherRate" type="number" step="0.001" min="0">
                            </div>
                        </div>

                        <div class="mt-4 d-flex gap-2">
                            <button type="submit" class="btn btn-primary">Create Warehouse</button>
                            <a class="btn btn-outline-secondary" th:href="@{/api/super/warehouses}">Cancel</a>
                        </div>
                    </form>
                </div>

                <div class="card-footer">
                    <a th:href="@{/api/super}">Back to Super Admin</a>
                </div>
            </div>
        </div>
    </div>
    <script th:src="@{/js/newTaxRate.js}"></script>
</section>
</html>
