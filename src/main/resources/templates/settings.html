<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <title>Settings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body>
<div class="container mt-4">
    <h3>Settings</h3>

    <!-- flash message -->
    <div th:if="${message}" class="alert alert-info" th:text="${message}"></div>

    <form th:object="${settingsDto}" th:action="@{/settings}" method="post" class="row g-3">
        <!-- CSRF -->
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <input type="hidden" th:field="*{id}"/>

        <div class="col-12">
            <label class="form-label">Manager</label>
            <input class="form-control" th:value="${settingsDto.managerId != null ? settingsDto.managerId.username : ''}" readonly/>
        </div>
        <input type="hidden" th:field="*{managerId}" />

        <div class="col-md-6 form-check">
            <input class="form-check-input" type="checkbox" th:field="*{alertWhenStockIsLow}" id="alertWhenStockIsLow"/>
            <label class="form-check-label" for="alertWhenStockIsLow">Alert when stock is low</label>
        </div>

        <div class="col-md-6 form-check">
            <input class="form-check-input" type="checkbox" th:field="*{autoGenerateReport}" id="autoGenerateReport"/>
            <label class="form-check-label" for="autoGenerateReport">Auto-generate report</label>
        </div>

        <div class="col-md-6">
            <label class="form-label">Auto-generate report time</label>
            <input
                    id="autoGenerateReportTime_view"
                    class="form-control"
                    type="time"
                    step="1"
                    th:value="${settingsDto.autoGenerateReportTime != null ? settingsDto.autoGenerateReportTime.toLocalTime().toString().substring(0,5) : ''}"
            />
            <input
                    id="autoGenerateReportTime"
                    type="hidden"
                    th:field="*{autoGenerateReportTime}"
            />

            <div class="text-danger"
                 th:if="${#fields.hasErrors('autoGenerateReportTime')}"
                 th:errors="*{autoGenerateReportTime}"></div>
        </div>

        <div class="col-md-6">
            <label class="form-label">Notify minimum cash discrepancy</label>
            <input class="form-control" type="number" step="0.01" min="0" th:field="*{notifyMinimumCashDiscrepancy}"/>
            <div class="text-danger" th:if="${#fields.hasErrors('notifyMinimumCashDiscrepancy')}" th:errors="*{notifyMinimumCashDiscrepancy}"></div>
        </div>

        <div class="col-md-6">
            <label class="form-label">Destroy refund data after (days)</label>
            <input class="form-control" type="number" step="1" min="0" th:field="*{destroyRefundDataAfterNDays}"/>
            <div class="text-danger" th:if="${#fields.hasErrors('destroyRefundDataAfterNDays')}" th:errors="*{destroyRefundDataAfterNDays}"></div>
        </div>

        <div class="col-md-6">
            <label class="form-label">Cash count start time</label>
            <input class="form-control" type="time" step="1" th:field="*{cashCountStartTime}"/>
            <div class="text-danger" th:if="${#fields.hasErrors('cashCountStartTime')}" th:errors="*{cashCountStartTime}"></div>
        </div>

        <div class="col-md-6">
            <label class="form-label">Cash count end time</label>
            <input class="form-control" type="time" step="1" th:field="*{cashCountEndTime}"/>
            <div class="text-danger" th:if="${#fields.hasErrors('cashCountEndTime')}" th:errors="*{cashCountEndTime}"></div>
        </div>

        <div class="col-12 mt-3">
            <button type="submit" class="btn btn-primary">Save</button>
            <a th:href="@{/api/admin}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    (function(){
        const chk = document.getElementById('autoGenerateReport');
        const view = document.getElementById('autoGenerateReportTime_view');
        const hidden = document.getElementById('autoGenerateReportTime');

        function syncHiddenFromView() {
            const v = view.value; // "HH:MM" или ""
            if (!v) {
                hidden.value = '';
            } else {
                hidden.value = v.length === 5 ? v + ':00' : v; // "HH:MM:SS"
            }
        }

        function updateState() {
            if (chk.checked) {
                view.removeAttribute('disabled');
                syncHiddenFromView();
            } else {
                view.setAttribute('disabled','disabled');
                hidden.value = ''; // отправится пустая строка -> initBinder -> null
            }
        }

        chk.addEventListener('change', updateState);
        view.addEventListener('input', syncHiddenFromView);

        // init
        document.addEventListener('DOMContentLoaded', function(){
            // если thymeleaf уже вставил value в hidden (при рендере), не затираем
            // но синхронизируем начальное значение view->hidden
            syncHiddenFromView();
            updateState();
        });
    })();
</script>
</body>
</html>
